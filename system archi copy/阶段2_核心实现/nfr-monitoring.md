## 非功能性需求与监控

## 概述

学生安全监控平台需要具备全面可观测性，以确保在上课时间（7AM–6PM）维持 **p95 延迟低于 3 秒**、**99.5%+ 的可用性**，并严格遵守隐私与公平性要求。该监控策略覆盖性能、可靠性、安全性以及机器学习模型质量，适用于服务 **500–2000 间并发教室**的边缘到云端基础设施。

重点关注领域：实时安全检测性能（涵盖考场压力崩溃、群体孤立霸凌、自残行为干预、教师语言暴力、网络溯源追踪五大场景）、隐私合规验证、算法公平性监测，以及通过混沌工程与合成监控进行的主动事件预防。

## 关键指标 (KPI) 与目标值

| 类别      | 指标            | 目标值          | 业务影响    | 监测周期       |
| ------- | ------------- | ------------ | ------- | ---------- |
| **性能**  | 端到端告警延迟（p95）  | ≤ 3 秒，从行为发生到L1预警平均延迟 ≤ 1.2 秒        | 教师响应时间  | 实时         |
|         | API 响应时间（p95） | ≤ 500 毫秒     | 用户体验    | 实时         |
|         | 机器学习推理延迟      | ≤ 300 毫秒/模型  | 告警生成速度  | 实时         |
|         | 吞吐能力          | 50,000 事件/分钟 | 高峰流量处理  | 高峰时段       |
| **可靠性** | 系统可用性（上课时间）   | ≥ 99.5%      | 服务可用性   | 每日 7AM–6PM |
|         | 告警发送成功率       | ≥ 99.9%      | 关键通知可靠性 | 实时         |
|         | 恢复时间目标 (RTO)  | ≤ 30 分钟      | 事件解决时间  | 每次事件       |
|         | 恢复点目标 (RPO)   | ≤ 5 分钟       | 数据丢失防护  | 每次事件       |
| **质量**  | 误报率 (FPR)     | ≤ 10%        | 教师信任与采纳 | 每日平均       |
|         | 模型准确率 (F1 分数) | ≥ 90%        | 安全检测有效性 | 每日评估       |
|         | 跨人口统计偏差差异     | ≤ 5%         | 公平性与合规性 | 每周分析       |
|         | 隐私合规率         | 100%         | 法规遵循    | 持续监测       |

## SLI/SLO 配置

| 服务等级目标 (SLO)    | 服务等级指标 (SLI)                                                | 错误预算       | 告警阈值               | 消耗速率     |
| --------------- | ----------------------------------------------------------- | ---------- | ------------------ | -------- |
| **告警生成 SLO**    | `rate(alert_delivery_duration{p95} < 3s)`                   | 28 天内 5%   | P95 > 3.5s 持续 5 分钟 | 14.4%/小时 |
| **API 可用性 SLO** | `rate(http_requests{status!~"5.."})/rate(http_requests)`    | 30 天内 0.5% | 成功率 < 99%          | 72%/小时   |
| **模型性能 SLO**    | `avg(model_f1_score{safety=true})`                          | 允许 10% 降低  | F1 < 0.85 持续 30 分钟 | N/A      |
| **上课时间可用性 SLO** | `up{component="core"} during 7AM-6PM`                       | 停机 0.5%    | 核心服务宕机             | 立即       |
| **公平性 SLO**     | `max(bias_disparity_by_demo) - min(bias_disparity_by_demo)` | 5% 方差      | 方差 > 7%            | 每周       |
| **隐私合规 SLO**    | `rate(consent_violations == 0)`                             | 0% 容忍      | 发现任何违规             | 立即       |

---

## 可观测性栈

**应用性能监控 (APM)**

* **Datadog APM**：跨微服务分布式追踪，自动生成服务拓扑，代码级性能洞察
* **自定义埋点**：跟踪 ML 推理延迟、隐私脱敏性能、边缘到云的延迟

**指标与时序数据**

* **Prometheus**：15 秒抓取间隔的核心指标采集
* **InfluxDB**：高基数时序数据（模型指标、边缘设备遥测）
* **自定义 Exporter**：隐私合规、模型公平性、同意管理 KPI

**日志与可观测性**

* **ELK**：集中式日志管理（Elasticsearch、Logstash、Kibana）
* **结构化日志**：JSON + 关联 ID，隐私字段脱敏
* **日志保留**：应用日志 90 天，审计日志 7 年

**实时监控**

* **Grafana**：主仪表盘，RBAC 控制
* **定制看板**：高管摘要、运营中心、模型性能、隐私合规
* **移动告警**：PagerDuty（关键事件），Slack（团队协调）

---

## 告警规则

| 告警         | 条件                               | 阈值    | 行动            | 升级路径                     |
| ---------- | -------------------------------- | ----- | ------------- | ------------------------ |
| **告警延迟过高** | `p95_alert_latency > 3.5s`       | 5 分钟  | 呼叫值班工程师       | 平台团队 → 工程经理（30 分钟）       |
| **系统宕机**   | `up == 0`                        | 1 分钟  | 关键呼叫 + 自动事件   | 平台团队 → CTO（立即）           |
| **高错误率**   | `error_rate > 5%`                | 3 分钟  | 呼叫值班 + 触发回滚   | 平台团队 → 产品团队（15 分钟）       |
| **隐私违规**   | `privacy_violations > 0`         | 立即    | 关键呼叫 + 法务通知   | 隐私官 + 法务（立即）             |
| **模型精度下降** | `model_f1_score < 0.80`          | 30 分钟 | 通知 ML 团队      | ML 工程师 → AI/ML 总监（60 分钟） |
| **偏差阈值超标** | `demographic_disparity > 10%`    | 每日    | 公平性审查 + 模型重训  | ML 团队 → 伦理委员会（24 小时）     |
| **同意系统故障** | `consent_check_failures > 1%`    | 5 分钟  | 呼叫隐私团队 + 停止系统 | 隐私官 → DPO（15 分钟）         |
| **边缘设备离线** | `edge_device_connectivity < 95%` | 10 分钟 | 通知现场运维        | IT 支持 → 设施部门（60 分钟）      |

---

## 压测与混沌测试计划

**负载测试**

* **基准测试**：每周模拟 4 万并发事件（峰值 80%）
* **峰值测试**：每月 150% 容量测试，验证自动扩容
* **压力测试**：每季度推到失效点，识别瓶颈

**混沌工程**

* **每周**：随机终止 10% 非关键服务 Pod，网络分区测试
* **每月**：数据库故障切换、单可用区宕机、模型回滚
* **每季度**：全区域宕机、跨区域切换、数据恢复验证
* **爆炸半径**：最大影响 25% 服务，上课时间禁用，错误率 >5% 自动中止

---

## 运行手册与响应流程

**事件响应手册**

* [高延迟响应](https://wiki.company.com/incident-response/high-latency)
* [隐私事件响应](https://wiki.company.com/incident-response/privacy-breach)
* [模型性能问题](https://wiki.company.com/incident-response/model-performance)
* [系统中断恢复](https://wiki.company.com/incident-response/system-outage)

**运营流程**

* [每日健康检查](https://wiki.company.com/operations/daily-health-check)
* [部署验证](https://wiki.company.com/operations/deploy-verification)
* [容量规划](https://wiki.company.com/operations/capacity-planning)
* [紧急联系人](https://wiki.company.com/operations/emergency-contacts)

**合规与审计**

* [隐私审计流程](https://wiki.company.com/compliance/privacy-audit)
* [安全检查清单](https://wiki.company.com/compliance/security-review)
* [模型公平性评估](https://wiki.company.com/compliance/fairness-evaluation)

---

## 仪表盘检查清单

**高管看板**

* [ ] 系统健康总览（可用性、关键指标、事件数）
* [ ] 安全指标摘要（告警数、响应时间、误报率）
* [ ] 合规状态板（隐私、安全、公平性指标）

**运维看板**

* [ ] 实时系统状态（健康、错误率、资源利用）
* [ ] 性能监控（延迟分位数、吞吐量、队列深度）
* [ ] 基础设施健康（跨区域 CPU、内存、存储、网络）

**ML/AI 看板**

* [ ] 模型性能（准确率、精确率、召回率、F1）
* [ ] 推理延迟与吞吐量（按模型类型与批量大小）
* [ ] 公平性与偏差监测（人口统计平等、机会均等）

**隐私与安全看板**

* [ ] 隐私合规指标（同意率、数据保留、访问请求）
* [ ] 安全监控（失败登录、未授权访问、漏洞扫描）
* [ ] 审计轨迹可视化（用户行为、数据访问、合规事件）
